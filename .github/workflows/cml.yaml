name: Model-Training-Workflow
on: [push]
jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install dvc[s3] cml

      - name: Pull data from DVC
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: us-east-1
        run: |
          # dvc remote modify storage url s3://custom-bucket/path if needed
          dvc pull data/raw.dvc

      - name: Train Model
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # If src/train.py is missing, this will fail gracefully with clear error
          if [ ! -f src/train.py ]; then
            echo "## Training Error" > report.md
            echo "File \`src/train.py\` not found. Skipping training." >> report.md
            cml send-comment report.md
            exit 1
          fi

          python src/train.py

          echo "## Model Metrics" > report.md
          if [ -f metrics.json ]; then
            cat metrics.json >> report.md
          else
            echo "Metrics not found." >> report.md
          fi

          echo "## Confusion Matrix" >> report.md
          if [ -f confusion_matrix.png ]; then
            cml-publish confusion_matrix.png --md >> report.md
          else
            echo "Confusion matrix image not found." >> report.md
          fi

          cml send-comment report.md
