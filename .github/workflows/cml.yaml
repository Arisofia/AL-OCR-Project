name: Model-Training-Workflow
on: [push]
jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Validate Secrets
        run: |
          for secret in AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY; do
            if [ -z "${!secret}" ]; then
              echo "::warning ::Secret $secret is not set!"
            else
              echo "âœ… $secret is set."
            fi
          done
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt
          pip install --no-cache-dir cml

      - name: Pull data from DVC
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: us-east-1
        run: |
          if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$AWS_SECRET_ACCESS_KEY" ]; then
            echo "::warning ::AWS secrets not set. Skipping dvc pull."
          else
            # dvc remote modify storage url s3://custom-bucket/path if needed
            dvc pull data/raw.dvc
          fi

      - name: Train Model
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # If src/train.py is missing, this will fail gracefully with clear error
          if [ ! -f src/train.py ]; then
            echo "## Training Error" > report.md
            echo "File \`src/train.py\` not found. Skipping training." >> report.md
            cml send-comment report.md
            exit 1
          fi

          python src/train.py

          echo "## Model Metrics" > report.md
          if [ -f metrics.json ]; then
            echo '\n```json' >> report.md
            cat metrics.json >> report.md
            echo '\n```' >> report.md
          else
            echo "Metrics not found." >> report.md
          fi

          echo "## Confusion Matrix" >> report.md
          if [ -f confusion_matrix.png ]; then
            cml-publish confusion_matrix.png --md >> report.md
          else
            echo "Confusion matrix image not found." >> report.md
          fi

          cml send-comment report.md
