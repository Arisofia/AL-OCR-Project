---
name: Python Tests

on:
  pull_request:
    paths:
      - 'ocr-service/**'
      - 'ocr_reconstruct/**'
      - '.github/workflows/python-tests.yml'
  push:
    branches:
      - main
    paths:
      - 'ocr-service/**'
      - 'ocr_reconstruct/**'

jobs:
  tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11']
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Python
        uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c # v5.0.0
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install system deps (Tesseract & OpenCV)
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr libtesseract-dev libgl1-mesa-glx libglib2.0-0

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Cache pip
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.0.2
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Linting Tools
        run: |
          pip install flake8 pylint mypy types-requests types-python-dateutil

      - name: Install ocr_reconstruct (editable) and deps
        run: |
          set -x
          python -m pip install -e ./ocr_reconstruct
          pip install -r ocr_reconstruct/requirements.txt

      - name: Install OCR service deps
        run: |
          pip install -r ocr-service/requirements.txt

      - name: Run Type Checking (mypy)
        run: |
          mypy ocr-service ocr_reconstruct --ignore-missing-imports --no-strict-optional

      - name: Run Linting (flake8)
        run: |
          # Use the root .flake8 config if it exists
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 ocr-service ocr_reconstruct --count --max-complexity=10 --max-line-length=88 --statistics

      - name: Run Linting (pylint)
        run: |
          # Only lint the core service folders
          pylint ocr-service ocr_reconstruct --fail-under=8.0

      - name: Save ocr-service pip environment (debug)
        if: ${{ always() }}
        run: |
          mkdir -p artifacts || true
          pip --version > artifacts/pip_version.txt || true
          pip freeze > artifacts/pip_freeze.txt || true
          python -V > artifacts/python_version.txt || true
          env > artifacts/env.txt || true

      - name: Upload ocr-service pip debug artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: ocr-service-pip-debug-${{ matrix.python-version }}
          path: artifacts

      - name: Generate sample images
        run: |
          python ocr_reconstruct/tests/generate_samples.py

      - name: Run ocr_reconstruct tests
        run: |
          pytest ocr_reconstruct/tests -q

      - name: Uninstall editable ocr_reconstruct to avoid module name collisions
        run: |
          pip uninstall -y ocr_reconstruct || true

      - name: Run ocr-service tests
        env:
          OCR_API_KEY: default_secret_key
          PYTHONPATH: ${{ github.workspace }}:${{ github.workspace }}/ocr-service
        working-directory: ./ocr-service
        run: |
          # Run quick import checks and save output to a debug file for artifact upload
          python - <<'PY' > debug_imports.txt
          import os, sys, importlib
          print('OCR_API_KEY:', os.getenv('OCR_API_KEY'))
          print('PYTHONPATH:', os.getenv('PYTHONPATH'))
          print('sys.path:', sys.path)
          for name in ('services', 'modules', 'main', 'lambda_handler'):
              try:
                  m = importlib.import_module(name)
                  print(name, '->', getattr(m, '__file__', '<builtin>'))
              except Exception as e:
                  print('IMPORT ERROR', name, type(e), e)
          PY

          # Show the debug file for logs and then run tests
          cat debug_imports.txt || true
          pytest tests -q
      - name: Upload ocr-service debug artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: ocr-service-debug-${{ matrix.python-version }}
          path: ./ocr-service/debug_imports.txt
