---
name: Python Tests

on:
  pull_request:
    paths:
      - "ocr_service/**"
      - "ocr_reconstruct/**"
      - ".github/workflows/python-tests.yml"
  push:
    branches:
      - main
    paths:
      - "ocr_reconstruct/**"
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11"]
    steps:
      - uses: actions/checkout@v4

      - name: Validate Secrets
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
          OCR_API_KEY: ${{ secrets.OCR_API_KEY }}
        run: |
          echo "### Secret Validation Results" >> "$GITHUB_STEP_SUMMARY"
          for secret in CODECOV_TOKEN OCR_API_KEY; do
            if [ -z "${!secret}" ]; then
              echo "::warning ::Secret $secret is not set!"
              echo "⚠️ **$secret** is missing" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "✅ $secret is set."
              echo "✅ $secret is set" >> "$GITHUB_STEP_SUMMARY"
            fi
          done

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install system deps (Tesseract & OpenCV)
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr libtesseract-dev libgl1 libglib2.0-0

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: >-
            ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt',
            'requirements-dev.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Cache pre-commit hooks
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key:
            ${{ runner.os }}-pre-commit-${{ hashFiles('.pre-commit-config.yaml')
            }}
          restore-keys: |
            ${{ runner.os }}-pre-commit-

      - name: Install dependencies (minimal for tests)
        run: |
          python -m pip install -r requirements.txt
          python -m pip install -r requirements-dev.txt
          python -m pip install -e ./ocr_reconstruct

      - name: Run Linting and Formatting Check (ruff)
        run: |
          ruff check .
          ruff format --check .

      - name: Run Security Scan (bandit)
        run: |
          bandit -c bandit.yaml -r ocr_service ocr_reconstruct -ll

      - name: Run Dependency Audit (pip-audit)
        run: |
          if [ "${{ matrix.python-version }}" == "3.9" ]; then
            pip-audit -r ocr_service/requirements.txt --allow-unfixed || true
          else
            pip-audit -r ocr_service/requirements.txt
          fi
          pip-audit -r ocr_reconstruct/requirements.txt

      - name: Run Type Checking (mypy)
        continue-on-error: true
        run: |
          mypy .

      - name: Run Pre-commit Hooks
        continue-on-error: true
        run: |
          pre-commit run --all-files

      - name: Save debug environment
        if: ${{ always() }}
        run: |
          mkdir -p artifacts
          pip --version > artifacts/pip_version.txt
          pip freeze > artifacts/pip_freeze.txt
          python -V > artifacts/python_version.txt
          env > artifacts/env.txt


      # ...existing code...

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./ocr_service/coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Debug Import Check
        if: ${{ always() }}
        env:
          PYTHONPATH: ${{ github.workspace }}
          OCR_API_KEY: ${{ secrets.OCR_API_KEY }}
        run: |
          # Run quick import checks and save output to a debug file for artifact upload
          python - <<'PY' > ./ocr_service/debug_imports.txt
          import os, sys, importlib
          print('OCR_API_KEY:', os.getenv('OCR_API_KEY'))
          print('PYTHONPATH:', os.getenv('PYTHONPATH'))
          print('sys.path:', sys.path)
          for name in ('services', 'modules', 'main', 'lambda_handler'):
              try:
                  m = importlib.import_module(f"ocr_service.{name}")
                  print(name, '->', getattr(m, '__file__', '<builtin>'))
              except Exception as e:
                  print('IMPORT ERROR', name, type(e), e)
          PY
          cat ./ocr_service/debug_imports.txt || true

