name: "Build and Deploy Docker Image"

on:
  push:
    branches:
      - main
    paths:
      - 'ocr-service/**'
      - 'ocr_reconstruct/**'
      - '.github/workflows/docker-deploy.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'ocr-service/**'
      - 'ocr_reconstruct/**'
      - '.github/workflows/docker-deploy.yml'

permissions:
  contents: read
  id-token: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      LAMBDA_FUNCTION_NAME: al-ocr-processor
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Configure AWS Credentials
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502 # v4.0.2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: us-east-1

      - name: Confirm AWS identity (debug)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: |
          echo "Confirming AWS identity (debug)"
          aws sts get-caller-identity || true

      - name: Login to Amazon ECR
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: aws-actions/amazon-ecr-login@v2 # v2.0.1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@f95db51fddba0c2d1ec667646a06c2ce06100226 # v3.0.0

      - name: Build image
        run: |
          # Use a local tag for building and scanning
          docker buildx build --platform linux/amd64 -t al-ocr-service:${{ github.sha }} --load -f ./ocr-service/Dockerfile .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@915b19bbe73b92a6cf82a1bc12b087c9a19a5fe2 # v0.28.0
        with:
          image-ref: al-ocr-service:${{ github.sha }}
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      - name: Push image to ECR
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        env:
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
        run: |
          IMAGE_URI=${AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com/al-ocr-service:${{ github.sha }}
          LATEST_URI=${AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com/al-ocr-service:latest
          docker tag al-ocr-service:${{ github.sha }} $IMAGE_URI
          docker tag al-ocr-service:${{ github.sha }} $LATEST_URI
          docker push $IMAGE_URI
          docker push $LATEST_URI

      - name: Update Lambda image
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        env:
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
        run: |
          IMAGE_URI=${AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com/al-ocr-service:${{ github.sha }}
          aws lambda update-function-code --function-name $LAMBDA_FUNCTION_NAME --image-uri $IMAGE_URI
