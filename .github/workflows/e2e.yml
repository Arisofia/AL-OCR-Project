---
name: Playwright E2E

on:
  pull_request:
    paths:
      - 'frontend/**'
      - 'ocr_service/**'
      - '.github/workflows/e2e.yml'
  workflow_dispatch:

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      # actions/checkout v4.2.2
      - uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98

      # actions/setup-python v5.0.0
      - name: Setup Python
        uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c
        with:
          python-version: '3.10'

      - name: Setup Node
        uses: actions/setup-node@b39b52d1213e96004bfcb1c61a8a6fa8ab84f3e8 # v4.0.1
        with:
          node-version: '20'

      - name: Install system deps
        run: |
          sudo apt-get update
          # Use Playwright-friendly packages on Ubuntu 24.04; libgl1-mesa-glx may be unavailable
          sudo apt-get install -y tesseract-ocr libtesseract-dev libglib2.0-0 libgbm1 libgtk-3-0 libasound2 libnss3 libxss1

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r ocr_service/requirements.txt
          pip install -r ocr_reconstruct/requirements.txt

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install Node deps
        working-directory: ./frontend
        run: |
          npm ci

      - name: Run Frontend Lint
        working-directory: ./frontend
        run: npm run lint

      - name: Frontend Dependency Scan (Trivy)
        uses: aquasecurity/trivy-action@915b19bbe73b92a6cf82a1bc12b087c9a19a5fe2 # v0.28.0
        with:
          scan-type: 'fs'
          scan-ref: 'frontend'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright browsers
        working-directory: ./frontend
        run: npx playwright install --with-deps

      - name: Build frontend (for preview)
        working-directory: ./frontend
        env:
          VITE_API_BASE: http://localhost:8000
          VITE_API_KEY: ${{ secrets.STAGING_API_KEY || '' }}
        run: |
          npm run build

      - name: Check Netlify secret availability
        id: check_netlify_secrets
        run: |
          if [ -n "${{ secrets.NETLIFY_AUTH_TOKEN }}" ]; then
            echo "has_netlify=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_netlify=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Deploy to Netlify (optional)
        if: ${{ steps.check_netlify_secrets.outputs.has_netlify == 'true' }}
        working-directory: ./frontend
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        id: netlify_deploy
        run: |
          (npx -y netlify-cli deploy \
            --dir=dist \
            --json --auth="$NETLIFY_AUTH_TOKEN") > netlify-deploy.json
          DEPLOY_URL=$(jq -r '.deploy_url' netlify-deploy.json)
          echo "DEPLOY_URL=$DEPLOY_URL" >> $GITHUB_ENV
          echo "Deployed preview to $DEPLOY_URL"

      - name: Start backend
        working-directory: ./ocr_service
        env:
          PYTHONPATH: ${{ github.workspace }}:${{ github.workspace }}/ocr_service
          OCR_API_KEY: ${{ secrets.OCR_API_KEY || '' }}
        run: |
          nohup uvicorn main:app --host 0.0.0.0 --port 8000 > ../backend.log 2>&1 &
          npx wait-on -t 30000 http://localhost:8000/health

      - name: Start frontend (serve built site when not deploying externally)
        working-directory: ./frontend
        run: |
          if [ -z "$DEPLOY_URL" ]; then
            SERVER_CMD="npx -y http-server dist -p 5173 --silent"
            nohup $SERVER_CMD > ../frontend.log 2>&1 &
            npx wait-on -t 20000 http://localhost:5173
          else
            echo "External preview available: $DEPLOY_URL"
          fi

      - name: Run Playwright tests
        working-directory: ./frontend
        env:
          VITE_API_KEY: ${{ secrets.STAGING_API_KEY || '' }}
        run: |
          export BASE_URL="${DEPLOY_URL:-http://localhost:5173}"
          echo "Using BASE_URL=$BASE_URL"
          npx playwright test --config=playwright.config.ts

      - name: Debug Logs on Failure
        if: failure()
        run: |
          echo "--- Backend Logs ---"
          [ -f backend.log ] && cat backend.log || echo "No backend.log found"
          echo "--- Frontend Logs ---"
          [ -f frontend.log ] && cat frontend.log || echo "No frontend.log found"

      - name: Upload Playwright artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: playwright-artifacts
          path: |
            frontend/test-results
            frontend/playwright-report
            frontend/tests/e2e/**/screenshots
            frontend/tests/e2e/**/videos
            frontend/tests/e2e/**/trace
